/*! ┌───────────────────────────────────────────────────────────────────────────────────────────┐ */
/*! │ FireCollab v0.0.1 - Collaboration powered by Firebase                                     │ */
/*! ├───────────────────────────────────────────────────────────────────────────────────────────┤ */
/*! │ Copyright © 2013 Miroslav Hibler (http://MiroHibler.github.com/FireCollab/)               │ */
/*! ├───────────────────────────────────────────────────────────────────────────────────────────┤ */
/*! │ Licensed under the MIT (http://miro.mit-license.org) license.                             │ */
/*! ├───────────────────────────────────────────────────────────────────────────────────────────┤ */
/*! │ Dependencies: JSON Operational Transform (JOT) (https://github.com/JoshData/jot)          │ */
/*! └───────────────────────────────────────────────────────────────────────────────────────────┘ */
function makeGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}function randomString(a){for(var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c="",d=0;a>d;d++)c+=b.charAt(Math.floor(Math.random()*b.length));return c}function FireCollabAdapter(){var a=require("jot/base.js"),b=require("jot/collab.js"),c=(require("jot/objects.js"),require("jot/sequences.js"),require("jot/values.js"),Object.subClass({get id(){return this._id},get dbName(){return this._dbName},get GUID(){return this._GUID},set timeSinceLastOp(a){this._timeSinceLastOp},get timeSinceLastOp(){return this._timeSinceLastOp},get queue(){return this._queue},get eventHandlers(){return this._eventHandlers},get eventLoop(){return this._eventLoop},get twoWayCollab(){return this._twoWayCollab},init:function(c,d){var e=this;return this._id=c,this._dbName=d?d:c,this._GUID=makeGUID(),this.timeSinceLastOp=0,this._queue={stage1:[],stage2:[]},this._eventHandlers={},this._eventLoop={pushLocalChange:function(a){e.queue.stage1.push(a)},flushLocalChanges:function(){var b=e.queue.stage2.concat(e.queue.stage1),b=a.normalize_array(b);b.length>0&&e.twoWayCollab.local_revision(b),e.queue.stage1=[],e.queue.stage2=[]}},this._twoWayCollab=new b.TwoWayCollaboration(function(a,b){e.eventHandlers.hasOwnProperty("update")&&e.eventHandlers.update(a,b)},function(a){e.eventHandlers.hasOwnProperty("send")&&e.eventHandlers.send(e,a)}),this},set:function(a){return FireCollab.set(a,this),this},sendQueue:function(){var b=this,c=a.normalize_array(b.queue.stage2);return c.length>0?(b.twoWayCollab.local_revision(c),b.timeSinceLastOp=0):b.twoWayCollab.needs_ack&&b.timeSinceLastOp>FireCollab.maxAckTime?(b.twoWayCollab.send_ping(),b.timeSinceLastOp=0):b.timeSinceLastOp+=1,b.queue.stage2=b.queue.stage1,b.queue.stage1=[],b.twoWayCollab.our_history=[],this},on:function(a,b){return a&&("object"==typeof a?this.eventHandlers=FireCollab.extend({},this.eventHandlers,a):this.eventHandlers[a]=b),this},off:function(a){if("string"==typeof a)this.eventHandlers.hasOwnProperty(a)&&(this.eventHandlers[a]=null);else for(var b in this.eventHandlers)this.eventHandlers[b]=null;return this}}));return c}"function"!=typeof Object.create&&(Object.create=function(a){function b(){}return b.prototype=a,new b}),String.prototype.splice=function(a,b,c){return this.slice(0,a)+c+this.slice(a+Math.abs(b))},function(a){var b,c,d="0.0.1",e="https://firecollab.firebaseio.com",f=!0,g=(require("jot/base.js"),[]),h=function(a,b){if("string"!=typeof a)throw new Error("Invalid baseURL provided");return new Firebase(a,b?new Firebase.Context:null)},i=function(b){a.setTimeout("fireCollabSendChanges()",b)},j=function(){return new j.fn.init};j.fn=j.prototype={constructor:j,get version(){return d},set bufferTime(a){this._opBufferTime=a},get bufferTime(){return this._opBufferTime},set maxAckTime(a){this._maxAckTime=a},get maxAckTime(){return this._maxAckTime},get db(){return c},init:function(){var d=this;return a.jQuery&&(this.extend=jQuery.extend),this._opBufferTime=250,this._maxAckTime=10,b=makeGUID(),c=h(e,f),a.fireCollabSendChanges=function(){for(var a=0;a<g.length;a++)g[a].sendQueue();i(d.bufferTime)},i(d.bufferTime),this},initDB:function(a,b){return c=h(a,b),this},register:function(a){if(a){g.push(a);var b=this;a.on("send",b.push),c.child(a.dbName).child("doc").once("value",function(b){a.eventHandlers.hasOwnProperty("init")&&a.eventHandlers.init(b.val()),a.eventHandlers.hasOwnProperty("update")&&c.child(a.dbName).child("history").on("child_added",function(b){var c=b.val();c.author!==a.GUID&&setTimeout(function(){a.eventLoop.flushLocalChanges(),a.twoWayCollab.process_remote_message(c.msg)},0)})})}return this},set:function(a,b){return this.db.child(b.dbName).child("doc").set(a),this},push:function(a,b){var d={author:a.GUID,msg:b};return c.child(a.dbName).child("history").push(d),this},extend:function(){for(var a=1;a<arguments.length;a++)for(var b in arguments[a])arguments[a].hasOwnProperty(b)&&(arguments[0][b]=arguments[a][b]);return arguments[0]}},j.fn.init.prototype=j.fn,"object"==typeof a&&(a.FireCollab=new j)}(window);